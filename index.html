<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Solar Plant Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body {
    font-family: Arial, sans-serif;
    background: #f2f2f2;
    padding: 15px;
}

h2 { text-align: center; margin-bottom: 15px; }

.filters {
    display: flex;
    gap: 20px;
    margin-bottom: 15px;
}

.dropdown {
    position: relative;
}

.dropdown button {
    padding: 3px 6px;
    border: 1px solid #999;
    background: white;
    cursor: pointer;
    font-size: 12px;
}

.dropdown-content {
    display: none;
    position: absolute;
    background: white;
    border: 1px solid #ccc;
    max-height: 260px;
    overflow-y: auto;
    padding: 8px;
    z-index: 10;
    width: 220px;
}

.dropdown:hover .dropdown-content {
    display: block;
}

.dropdown-content label {
    display: block;
    font-size: 12px;
    margin-bottom: 2px;
}

.action-btn {
    font-size: 12px;
    margin-bottom: 4px;
    width: 48%;
    cursor: pointer;
}

/* Top section */
.top-container {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    gap: 15px;
    margin-bottom: 20px;
}

.comparison-container {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
}

/* Chart */
.chart-container {
    width: 35%;
}

canvas {
    background: white;
    padding: 5px;
    border-radius: 10px;
}

/* Comparison tables */
.comparison-table {
    width: 140px;
    border-collapse: collapse;
    background: white;
}

.comparison-table th,
.comparison-table td {
    border: 1px solid #ccc;
    padding: 4px;
    text-align: center;
    font-size: 10px;
}

.comparison-table th {
    background: #34495e;
    color: white;
}

.diff-positive {
    background: #c8e6c9;
    color: #256029;
}

.diff-negative {
    background: #ffcccc;
    color: #a50000;
}

/* DATA TABLE */
.table-wrapper {
    max-height: 400px;
    overflow-y: auto;
    background: white;
}

.data-table {
    width: 100%;
    border-collapse: collapse;
}

.data-table th,
.data-table td {
    border: 1px solid #ccc;
    padding: 6px;
    font-size: 10px;
    text-align: center;
}

.data-table th {
    background: #34495e;
    color: white;
    position: sticky;
    top: 0;
}
</style>
</head>

<body>

<h2>☀️ Captive Plant Solar Park 1 & 2</h2>

<div class="filters">
    <div class="dropdown">
        <button>Select Plant</button>
        <div class="dropdown-content" id="plantFilter">
            <button class="action-btn" onclick="selectAll('plant')">Select All</button>
            <button class="action-btn" onclick="deselectAll('plant')">Deselect All</button>
        </div>
    </div>

    <div class="dropdown">
        <button>Select Month</button>
        <div class="dropdown-content" id="monthFilter">
            <button class="action-btn" onclick="selectAll('month')">Select All</button>
            <button class="action-btn" onclick="deselectAll('month')">Deselect All</button>
        </div>
    </div>
</div>

<!-- TOP SECTION -->
<div class="top-container">

    <div class="comparison-container">

        <!-- Generation -->
        <div>
            <h4 style="text-align:center;color:red;">Total Generation</h4>
            <table class="comparison-table">
                <tr><th>Actual</th><th>Expected</th><th>Diff</th></tr>
                <tr>
                    <td id="genActual">0</td>
                    <td id="genExpected">0</td>
                    <td id="genDiff">0%</td>
                </tr>
            </table>
        </div>

        <!-- IR -->
        <div>
            <h4 style="text-align:center;color:purple;">Avg IR (kWh/m²)</h4>
            <table class="comparison-table">
                <tr><th>Actual</th><th>Expected</th><th>Diff</th></tr>
                <tr>
                    <td id="irActual">0</td>
                    <td id="irExpected">0</td>
                    <td id="irDiff">0%</td>
                </tr>
            </table>
        </div>

        <!-- PR & CUF -->
        <div>
            <h4 style="text-align:center;color:green;">Avg PR % & CUF %</h4>
            <table class="comparison-table">
                <tr>
                    <th></th>
                    <th>PR %</th>
                    <th>CUF %</th>
                </tr>
                <tr>
                    <th>Actual</th>
                    <td id="prActual">0%</td>
                    <td id="cufActual">0%</td>
                </tr>
                <tr>
                    <th>Expected</th>
                    <td id="prExpected">0%</td>
                    <td id="cufExpected">0%</td>
                </tr>
            </table>
        </div>

    </div>

    <!-- Chart -->
    <div class="chart-container">
        <canvas id="barChart"></canvas>
    </div>
</div>

<!-- DATA TABLE -->
<div class="table-wrapper">
<table class="data-table" id="dataTable">
    <thead></thead>
    <tbody></tbody>
</table>
</div>

<script>
// ===== SHEET CONFIG =====
const SHEET_ID = "1Y3cr91xEEQj86B9hXMYdpp6UU1a33-vlrFcWKkLRujg";
const GID = "0";

const PLANT_COL = 0;
const MONTH_COL = 1;
const ACTUAL_COL = 3;
const EXPECTED_COL = 4;
const IR_ACTUAL_COL = 5;
const IR_EXPECTED_COL = 6;
const PR_COL = 7;
const PR_EXP_COL = 8;
const CUF_COL = 10;
const CUF_EXP_COL = 11;

let allData = [];
let selectedPlants = new Set();
let selectedMonths = new Set();
let chart;

fetch(`https://docs.google.com/spreadsheets/d/${SHEET_ID}/export?format=csv&gid=${GID}`)
.then(r => r.text())
.then(csv => {
    const rows = csv.split("\n").map(r => r.split(",").map(c => c.replace(/"/g,"").trim()));
    const headers = rows.shift();
    allData = rows;
    document.querySelector("#dataTable thead").innerHTML =
        "<tr>"+headers.map(h=>`<th>${h}</th>`).join("")+"</tr>";
    createFilters();
    updateView();
});

function createFilters(){
    [...new Set(allData.map(r=>r[PLANT_COL]))].forEach(v=>addCB("plantFilter",v,selectedPlants));
    [...new Set(allData.map(r=>r[MONTH_COL]))].forEach(v=>addCB("monthFilter",v,selectedMonths));
}

function addCB(id,val,set){
    const l=document.createElement("label");
    const c=document.createElement("input");
    c.type="checkbox"; c.checked=true; set.add(val);
    c.onchange=()=>{c.checked?set.add(val):set.delete(val);updateView();};
    l.append(c," "+val);
    document.getElementById(id).appendChild(l);
}

function selectAll(t){
    const s=t==="plant"?selectedPlants:selectedMonths;
    document.querySelectorAll(`#${t}Filter input`).forEach(cb=>{
        cb.checked=true; s.add(cb.parentNode.textContent.trim());
    });
    updateView();
}
function deselectAll(t){
    const s=t==="plant"?selectedPlants:selectedMonths;
    s.clear();
    document.querySelectorAll(`#${t}Filter input`).forEach(cb=>cb.checked=false);
    updateView();
}

function updateView(){
    updateTable();
    updateChart();
    updateSummary();
}

function updateTable(){
    const tb=document.querySelector("#dataTable tbody");
    tb.innerHTML="";
    allData.forEach(r=>{
        if(selectedPlants.has(r[PLANT_COL])&&selectedMonths.has(r[MONTH_COL])){
            tb.innerHTML+="<tr>"+r.map(c=>`<td>${c}</td>`).join("")+"</tr>";
        }
    });
}

function updateSummary(){
    let ag=0,eg=0,irA=0,irE=0,prA=0,prE=0,cufA=0,cufE=0,c=0;

    allData.forEach(r=>{
        if(selectedPlants.has(r[PLANT_COL])&&selectedMonths.has(r[MONTH_COL])){
            ag+=+r[ACTUAL_COL]||0; eg+=+r[EXPECTED_COL]||0;
            irA+=+r[IR_ACTUAL_COL]||0; irE+=+r[IR_EXPECTED_COL]||0;
            prA+=+r[PR_COL]||0; prE+=+r[PR_EXP_COL]||0;
            cufA+=+r[CUF_COL]||0; cufE+=+r[CUF_EXP_COL]||0;
            c++;
        }
    });

    document.getElementById("genActual").innerText=Math.round(ag).toLocaleString();
    document.getElementById("genExpected").innerText=Math.round(eg).toLocaleString();
    document.getElementById("genDiff").innerText=eg?(((ag-eg)/eg)*100).toFixed(2)+"%":"0%";

    document.getElementById("irActual").innerText=(irA/c).toFixed(2);
    document.getElementById("irExpected").innerText=(irE/c).toFixed(2);

    document.getElementById("prActual").innerText=(prA/c).toFixed(2)+"%";
    document.getElementById("prExpected").innerText=(prE/c).toFixed(2)+"%";
    document.getElementById("cufActual").innerText=(cufA/c).toFixed(2)+"%";
    document.getElementById("cufExpected").innerText=(cufE/c).toFixed(2)+"%";
}

function updateChart(){
    const m={};
    allData.forEach(r=>{
        if(selectedPlants.has(r[PLANT_COL])&&selectedMonths.has(r[MONTH_COL])){
            m[r[MONTH_COL]]=(m[r[MONTH_COL]]||0)+(+r[ACTUAL_COL]||0)/1000;
        }
    });
    if(chart) chart.destroy();
    chart=new Chart(barChart,{type:"bar",
        data:{labels:Object.keys(m),datasets:[{label:"Actual Gen (MWh)",data:Object.values(m),backgroundColor:"#4caf50"}]},
        options:{responsive:true}
    });
}
</script>

</body>
</html>
