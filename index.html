<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Solar Plant Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body {
    font-family: Arial, sans-serif;
    background: #f2f2f2;
    padding: 15px;
}

h2 { text-align: center; margin-bottom: 15px; }

.filters {
    display: flex;
    gap: 20px;
    margin-bottom: 15px;
}

.dropdown { position: relative; }

.dropdown button {
    padding: 3px 6px;
    border: 1px solid #999;
    background: white;
    cursor: pointer;
    font-size: 12px;
}

.dropdown-content {
    display: none;
    position: absolute;
    background: white;
    border: 1px solid #ccc;
    max-height: 260px;
    overflow-y: auto;
    padding: 8px;
    z-index: 10;
    width: 200px;
}

.dropdown:hover .dropdown-content { display: block; }

.dropdown-content label {
    display: block;
    font-size: 12px;
    margin-bottom: 2px;
}

.action-btn {
    font-size: 12px;
    margin-bottom: 2px;
    width: 48%;
    cursor: pointer;
}

.top-container {
    display: flex;
    justify-content: space-between;
    gap: 15px;
    margin-bottom: 20px;
}

.comparison-container {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
}

.chart-grid {
    width: 35%;
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 10px;
}

.chart-grid canvas {
    background: white;
    padding: 5px;
    border-radius: 10px;
}

.comparison-table {
    width: 120px;
    border-collapse: collapse;
    background: white;
}

.comparison-table th, .comparison-table td {
    border: 1px solid #ccc;
    padding: 4px;
    text-align: center;
    font-size: 10px;
}

.comparison-table th {
    background: #34495e;
    color: white;
}

.diff-positive { background:#c8e6c9; }
.diff-negative { background:#ffcccc; }

.table-wrapper {
    max-height: 400px;
    overflow-y: auto;
    background: white;
}

.data-table {
    width: 100%;
    border-collapse: collapse;
}

.data-table th, .data-table td {
    border: 1px solid #ccc;
    padding: 6px;
    font-size: 10px;
    text-align: center;
}

.data-table th {
    background: #34495e;
    color: white;
    position: sticky;
    top: 0;
}
</style>
</head>

<body>

<h2>☀️ Captive Plant Solar Park 1 & 2</h2>

<div class="filters">
    <div class="dropdown">
        <button>Select Plant</button>
        <div class="dropdown-content" id="plantFilter">
            <button class="action-btn" onclick="selectAll('plant')">Select All</button>
            <button class="action-btn" onclick="deselectAll('plant')">Deselect All</button>
        </div>
    </div>

    <div class="dropdown">
        <button>Select Month</button>
        <div class="dropdown-content" id="monthFilter">
            <button class="action-btn" onclick="selectAll('month')">Select All</button>
            <button class="action-btn" onclick="deselectAll('month')">Deselect All</button>
        </div>
    </div>
</div>

<div class="top-container">

<!-- ===== COMPARISON TABLES (UNCHANGED) ===== -->
<div class="comparison-container">

<div>
<h4 style="text-align:center;color:red;">Total Generation</h4>
<table class="comparison-table">
<tr><th>Actual</th><th>Expected</th><th>Diff</th></tr>
<tr><td id="genActual">0</td><td id="genExpected">0</td><td id="genDiff">0%</td></tr>
</table>
</div>

<div>
<h4 style="text-align:center;color:purple;">Total IR</h4>
<table class="comparison-table">
<tr><th>Actual</th><th>Expected</th><th>Diff</th></tr>
<tr><td id="irActual">0</td><td id="irExpected">0</td><td id="irDiff">0%</td></tr>
</table>
</div>

<div>
<h4 style="text-align:center;color:green;">Exp Gen diff with Actual IR</h4>
<table class="comparison-table">
<tr><th>Actual</th><th>Expected</th><th>Diff</th></tr>
<tr><td id="expIRActual">0</td><td id="expIRExpected">0</td><td id="expIRDiff">0%</td></tr>
</table>
</div>

<div>
<h4 style="text-align:center;color:#e74c3c;">Avg PR%</h4>
<table class="comparison-table">
<tr><th>Actual</th><th>Expected</th></tr>
<tr><td id="prActual">0%</td><td id="prExpected">0%</td></tr>
</table>
</div>

<div>
<h4 style="text-align:center;color:#2980b9;">Avg CUF%</h4>
<table class="comparison-table">
<tr><th>Actual</th><th>Expected</th></tr>
<tr><td id="cufActual">0%</td><td id="cufExpected">0%</td></tr>
</table>
</div>

</div>

<!-- ===== CHARTS ===== -->
<div class="chart-grid">
    <canvas id="barChart"></canvas>
    <canvas id="pieGen"></canvas>
    <canvas id="piePR"></canvas>
    <canvas id="pieCUF"></canvas>
</div>

</div>

<div class="table-wrapper">
<table class="data-table" id="dataTable">
<thead></thead>
<tbody></tbody>
</table>
</div>

<script>
const SHEET_ID="1Y3cr91xEEQj86B9hXMYdpp6UU1a33-vlrFcWKkLRujg";
const GID="0";

const PLANT_COL=0, MONTH_COL=1, ACTUAL_COL=3, EXPECTED_COL=4,
      IR_ACTUAL_COL=5, IR_EXPECTED_COL=6,
      PR_ACTUAL_COL=8, PR_EXPECTED_COL=9,
      CUF_ACTUAL_COL=10, CUF_EXPECTED_COL=11;

let allData=[], selectedPlants=new Set(), selectedMonths=new Set();
let barChart, pieGen, piePR, pieCUF;

fetch(`https://docs.google.com/spreadsheets/d/${SHEET_ID}/export?format=csv&gid=${GID}`)
.then(r=>r.text())
.then(csv=>{
    const rows=csv.split("\n").map(r=>r.split(",").map(c=>c.replace(/"/g,"").trim()));
    const headers=rows.shift();
    allData=rows;
    document.querySelector("#dataTable thead").innerHTML="<tr>"+headers.map(h=>`<th>${h}</th>`).join("")+"</tr>";
    createFilters();
    updateView();
});

function createFilters(){
    [...new Set(allData.map(r=>r[PLANT_COL]))].forEach(p=>addCheckbox("plantFilter",p,selectedPlants));
    [...new Set(allData.map(r=>r[MONTH_COL]))].forEach(m=>addCheckbox("monthFilter",m,selectedMonths));
}

function addCheckbox(id,val,set){
    const l=document.createElement("label");
    const c=document.createElement("input");
    c.type="checkbox"; c.checked=true; set.add(val);
    c.onchange=()=>{c.checked?set.add(val):set.delete(val);updateView();};
    l.appendChild(c); l.append(" "+val);
    document.getElementById(id).appendChild(l);
}

function selectAll(t){
    const s=t==="plant"?selectedPlants:selectedMonths;
    document.querySelectorAll(`#${t}Filter input`).forEach(c=>{c.checked=true;s.add(c.parentNode.textContent.trim())});
    updateView();
}
function deselectAll(t){
    const s=t==="plant"?selectedPlants:selectedMonths;
    s.clear();
    document.querySelectorAll(`#${t}Filter input`).forEach(c=>c.checked=false);
    updateView();
}

function updateView(){
    updateTable();
    updateComparison();
    updateCharts();
}

function updateTable(){
    const tb=document.querySelector("#dataTable tbody");
    tb.innerHTML="";
    allData.forEach(r=>{
        if(selectedPlants.has(r[PLANT_COL]) && selectedMonths.has(r[MONTH_COL])){
            const tr=document.createElement("tr");
            r.forEach(c=>{const td=document.createElement("td");td.innerText=c;tr.appendChild(td)});
            tb.appendChild(tr);
        }
    });
}

function updateComparison(){
    let ag=0,eg=0,ai=0,ei=0,prA=0,prE=0,cufA=0,cufE=0,c=0;
    let expIRAct=0,expIRExp=0;

    allData.forEach(r=>{
        if(selectedPlants.has(r[PLANT_COL]) && selectedMonths.has(r[MONTH_COL])){
            ag+=+r[ACTUAL_COL]||0; eg+=+r[EXPECTED_COL]||0;
            ai+=+r[IR_ACTUAL_COL]||0; ei+=+r[IR_EXPECTED_COL]||0;
            prA+=+r[PR_ACTUAL_COL]||0; prE+=+r[PR_EXPECTED_COL]||0;
            cufA+=+r[CUF_ACTUAL_COL]||0; cufE+=+r[CUF_EXPECTED_COL]||0;
            expIRAct+=+r[ACTUAL_COL]||0;
            expIRExp+=+r[ACTUAL_COL]*(+r[IR_EXPECTED_COL]/(+r[IR_ACTUAL_COL]||1));
            c++;
        }
    });

    genActual.innerText=Math.round(ag).toLocaleString();
    genExpected.innerText=Math.round(eg).toLocaleString();
    genDiff.innerText=((ag-eg)/eg*100).toFixed(2)+"%";

    irActual.innerText=(ai/c).toFixed(2);
    irExpected.innerText=(ei/c).toFixed(2);
    irDiff.innerText=(((ai/c)-(ei/c))/(ei/c)*100).toFixed(2)+"%";

    expIRActual.innerText=Math.round(expIRAct).toLocaleString();
    expIRExpected.innerText=Math.round(expIRExp).toLocaleString();
    expIRDiff.innerText=((expIRAct-expIRExp)/expIRExp*100).toFixed(2)+"%";

    prActual.innerText=(prA/c).toFixed(2)+"%";
    prExpected.innerText=(prE/c).toFixed(2)+"%";
    cufActual.innerText=(cufA/c).toFixed(2)+"%";
    cufExpected.innerText=(cufE/c).toFixed(2)+"%";
}

function updateCharts(){
    const gen={}, pr={}, cuf={};

    allData.forEach(r=>{
        if(selectedPlants.has(r[PLANT_COL]) && selectedMonths.has(r[MONTH_COL])){
            const p=r[PLANT_COL];
            gen[p]=(gen[p]||0)+(+r[ACTUAL_COL]/1000);
            pr[p]=(pr[p]||0)+(+r[PR_ACTUAL_COL]||0);
            cuf[p]=(cuf[p]||0)+(+r[CUF_ACTUAL_COL]||0);
        }
    });

    if(barChart)barChart.destroy();
    if(pieGen)pieGen.destroy();
    if(piePR)piePR.destroy();
    if(pieCUF)pieCUF.destroy();

    barChart=new Chart(barChart,{
        type:"bar",
        data:{labels:Object.keys(gen),datasets:[{label:"Actual Generation (MWh)",data:Object.values(gen),backgroundColor:"#4caf50"}]},
        options:{responsive:true}
    });

    pieGen=new Chart(pieGen,{type:"pie",data:{labels:Object.keys(gen),datasets:[{data:Object.values(gen)}]}});

    piePR=new Chart(piePR,{type:"pie",data:{labels:Object.keys(pr),datasets:[{data:Object.values(pr)}]}});

    pieCUF=new Chart(pieCUF,{type:"pie",data:{labels:Object.keys(cuf),datasets:[{data:Object.values(cuf)}]}});
}
</script>

</body>
</html>
