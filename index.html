<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Solar Plant Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body {
    font-family: Arial, sans-serif;
    background: #f2f2f2;
    padding: 15px;
}

h2 { text-align: center; margin-bottom: 15px; }

.filters {
    display: flex;
    gap: 20px;
    margin-bottom: 15px;
}

.dropdown {
    position: relative;
}

.dropdown button {
    padding: 8px 12px;
    border: 1px solid #333;
    background: white;
    cursor: pointer;
}

.dropdown-content {
    display: none;
    position: absolute;
    background: white;
    border: 1px solid #ccc;
    max-height: 260px;
    overflow-y: auto;
    padding: 8px;
    z-index: 10;
    width: 200px;
}

.dropdown:hover .dropdown-content {
    display: block;
}

.dropdown-content label {
    display: block;
    font-size: 13px;
    margin-bottom: 4px;
}

.action-btn {
    font-size: 12px;
    margin-bottom: 6px;
    width: 100%;
    cursor: pointer;
}

canvas {
    background: white;
    padding: 10px;
    border-radius: 6px;
    margin-bottom: 15px;
}

.comparison-table {
    width: 100%;
    max-width: 600px;
    margin: 10px auto;
    border-collapse: collapse;
    background: white;
}

.comparison-table th, .comparison-table td {
    border: 1px solid #ccc;
    padding: 8px;
    text-align: center;
    font-size: 14px;
}

.comparison-table th {
    background: #34495e;
    color: white;
}

.comparison-table .diff-positive {
    background: #c8e6c9;
    color: #256029;
}

.comparison-table .diff-negative {
    background: #ffcccc;
    color: #a50000;
}

.table-wrapper {
    max-height: 400px;
    overflow-y: auto;
    background: white;
    margin-top: 15px;
}

table.data-table {
    width: 100%;
    border-collapse: collapse;
}

.data-table th, .data-table td {
    border: 1px solid #ccc;
    padding: 6px;
    font-size: 13px;
    text-align: center;
}

.data-table th {
    background: #34495e;
    color: white;
    position: sticky;
    top: 0;
}
</style>
</head>

<body>

<h2>☀️ Solar Plant Performance Dashboard</h2>

<div class="filters">
    <!-- Plant Filter -->
    <div class="dropdown">
        <button>Select Plant</button>
        <div class="dropdown-content" id="plantFilter">
            <button class="action-btn" onclick="selectAll('plant')">Select All</button>
            <button class="action-btn" onclick="deselectAll('plant')">Deselect All</button>
        </div>
    </div>

    <!-- Month Filter -->
    <div class="dropdown">
        <button>Select Month</button>
        <div class="dropdown-content" id="monthFilter">
            <button class="action-btn" onclick="selectAll('month')">Select All</button>
            <button class="action-btn" onclick="deselectAll('month')">Deselect All</button>
        </div>
    </div>
</div>

<!-- CHART -->
<canvas id="barChart" width="400" height="150"></canvas>

<!-- COMPARISON TABLES -->
<h3 style="text-align:center; color:red;">Total Generation</h3>
<table class="comparison-table" id="genTable">
    <tr>
        <th>Actual</th>
        <th>Expected</th>
        <th>Diff</th>
    </tr>
    <tr>
        <td id="genActual">0</td>
        <td id="genExpected">0</td>
        <td id="genDiff">0%</td>
    </tr>
</table>

<h3 style="text-align:center; color:purple;">Total IR (KWh/m²)</h3>
<table class="comparison-table" id="irTable">
    <tr>
        <th>Actual</th>
        <th>Expected</th>
        <th>Diff</th>
    </tr>
    <tr>
        <td id="irActual">0</td>
        <td id="irExpected">0</td>
        <td id="irDiff">0%</td>
    </tr>
</table>

<h3 style="text-align:center; color:green;">Exp Gen diff with Actual IR</h3>
<table class="comparison-table" id="expIRTable">
    <tr>
        <th>Actual</th>
        <th>Expected</th>
        <th>Diff</th>
    </tr>
    <tr>
        <td id="expIRActual">0</td>
        <td id="expIRExpected">0</td>
        <td id="expIRDiff">0%</td>
    </tr>
</table>

<!-- DATA TABLE -->
<div class="table-wrapper">
<table class="data-table" id="dataTable">
    <thead></thead>
    <tbody></tbody>
</table>
</div>

<script>
// ================= SHEET DETAILS =================
const SHEET_ID = "1Y3cr91xEEQj86B9hXMYdpp6UU1a33-vlrFcWKkLRujg";
const GID = "0";
const MAX_COLUMNS = 19;

// Column index (0-based)
const PLANT_COL = 0;
const MONTH_COL = 1;
const ACTUAL_COL = 3;    // kWh
const EXPECTED_COL = 4;  // kWh
const IR_ACTUAL_COL = 5; // Actual IR column index
const IR_EXPECTED_COL = 6; // Expected IR column index

let allData = [];
let selectedPlants = new Set();
let selectedMonths = new Set();
let chart;

const sheetURL =
`https://docs.google.com/spreadsheets/d/${SHEET_ID}/export?format=csv&gid=${GID}`;

fetch(sheetURL)
.then(res => res.text())
.then(csv => {
    const rows = csv.split("\n").map(r =>
        r.split(",").slice(0, MAX_COLUMNS).map(c => c.replace(/"/g, "").trim())
    );

    const headers = rows.shift();
    allData = rows;

    createHeader(headers);
    createFilters();
    updateView();
});

// ---------- HEADER ----------
function createHeader(headers) {
    document.querySelector("#dataTable thead").innerHTML =
        "<tr>" + headers.map(h => `<th>${h}</th>`).join("") + "</tr>";
}

// ---------- FILTERS ----------
function createFilters() {
    const plantSet = new Set();
    const monthSet = new Set();

    allData.forEach(r => {
        plantSet.add(r[PLANT_COL]);
        monthSet.add(r[MONTH_COL]);
    });

    plantSet.forEach(p => addCheckbox("plantFilter", p, selectedPlants));
    monthSet.forEach(m => addCheckbox("monthFilter", m, selectedMonths));
}

function addCheckbox(containerId, value, set) {
    const div = document.getElementById(containerId);
    const label = document.createElement("label");
    const cb = document.createElement("input");

    cb.type = "checkbox";
    cb.checked = true;
    set.add(value);

    cb.onchange = () => {
        cb.checked ? set.add(value) : set.delete(value);
        updateView();
    };

    label.appendChild(cb);
    label.append(" " + value);
    div.appendChild(label);
}

// ---------- SELECT / DESELECT ----------
function selectAll(type) {
    const set = type === "plant" ? selectedPlants : selectedMonths;
    document.querySelectorAll(`#${type}Filter input[type=checkbox]`).forEach(cb => {
        cb.checked = true;
        set.add(cb.parentNode.textContent.trim());
    });
    updateView();
}

function deselectAll(type) {
    const set = type === "plant" ? selectedPlants : selectedMonths;
    set.clear();
    document.querySelectorAll(`#${type}Filter input[type=checkbox]`).forEach(cb => {
        cb.checked = false;
    });
    updateView();
}

// ---------- UPDATE ----------
function updateView() {
    updateTable();
    updateChart();
    updateComparisonTables();
}

// ---------- TABLE ----------
function updateTable() {
    const tbody = document.querySelector("#dataTable tbody");
    tbody.innerHTML = "";

    const frag = document.createDocumentFragment();

    allData.forEach(r => {
        if (selectedPlants.has(r[PLANT_COL]) && selectedMonths.has(r[MONTH_COL])) {
            const tr = document.createElement("tr");
            r.forEach(c=> {
                const td = document.createElement("td");
                td.innerText = c;
                tr.appendChild(td);
            });
            frag.appendChild(tr);
        }
    });

    tbody.appendChild(frag);
}

// ---------- COMPARISON TABLES ----------
function updateComparisonTables() {
    let actualGen=0, expectedGen=0;
    let actualIR=0, expectedIR=0;
    let expGenWithIRActual=0, expGenWithIRExpected=0;
    let countIR=0;

    allData.forEach(r => {
        if(selectedPlants.has(r[PLANT_COL]) && selectedMonths.has(r[MONTH_COL])){
            const act = Number(r[ACTUAL_COL]) || 0;
            const exp = Number(r[EXPECTED_COL]) || 0;
            actualGen += act;
            expectedGen += exp;

            const irAct = Number(r[IR_ACTUAL_COL]) || 0;
            const irExp = Number(r[IR_EXPECTED_COL]) || 0;
            actualIR += irAct;
            expectedIR += irExp;
            countIR++;

            const expIR = irAct > 0 ? act * (irExp/irAct) : act;
            expGenWithIRActual += act;
            expGenWithIRExpected += expIR;
        }
    });

    // Total Generation Table
    const genDiff = expectedGen ? ((actualGen - expectedGen)/expectedGen*100).toFixed(2) : 0;
    document.getElementById("genActual").innerText = actualGen.toLocaleString();
    document.getElementById("genExpected").innerText = expectedGen.toLocaleString();
    const genDiffCell = document.getElementById("genDiff");
    genDiffCell.innerText = genDiff + "%";
    genDiffCell.className = genDiff>=0 ? "diff-positive":"diff-negative";

    // Total IR Table
    const avgIRActual = countIR? (actualIR/countIR).toFixed(2):0;
    const avgIRExpected = countIR? (expectedIR/countIR).toFixed(2):0;
    const irDiff = avgIRExpected ? ((avgIRActual - avgIRExpected)/avgIRExpected*100).toFixed(2):0;
    document.getElementById("irActual").innerText = avgIRActual;
    document.getElementById("irExpected").innerText = avgIRExpected;
    const irDiffCell = document.getElementById("irDiff");
    irDiffCell.innerText = irDiff+"%";
    irDiffCell.className = irDiff>=0 ? "diff-positive":"diff-negative";

    // Exp Gen diff with Actual IR Table
    const expIRDiff = expGenWithIRExpected ? ((expGenWithIRActual - expGenWithIRExpected)/expGenWithIRExpected*100).toFixed(2):0;
    document.getElementById("expIRActual").innerText = expGenWithIRActual.toLocaleString();
    document.getElementById("expIRExpected").innerText = expGenWithIRExpected.toLocaleString();
    const expIRDiffCell = document.getElementById("expIRDiff");
    expIRDiffCell.innerText = expIRDiff+"%";
    expIRDiffCell.className = expIRDiff>=0 ? "diff-positive":"diff-negative";
}

// ---------- CHART ----------
function updateChart() {
    const monthTotals = {};

    allData.forEach(r => {
        if (selectedPlants.has(r[PLANT_COL]) && selectedMonths.has(r[MONTH_COL])) {
            const m = r[MONTH_COL];
            const gen = (Number(r[ACTUAL_COL]) || 0)/1000;
            monthTotals[m] = (monthTotals[m] || 0) + gen;
        }
    });

    if(chart) chart.destroy();

    chart = new Chart(document.getElementById("barChart"), {
        type: "bar",
        data: {
            labels: Object.keys(monthTotals),
            datasets:[{
                label:"Actual Generation (MWh)",
                data: Object.values(monthTotals),
                backgroundColor:'#4caf50',
                barThickness: 18
            }]
        },
        options:{
            responsive:true,
            scales:{
                x:{ ticks:{ font:{ size:10 }}},
                y:{ beginAtZero:true, ticks:{ font:{ size:12 }}}
            }
        }
    });
}
</script>

</body>
</html>
