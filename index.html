<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Solar Plant Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body {
    font-family: Arial, sans-serif;
    background: #f2f2f2;
    padding: 15px;
}

h2 { margin-bottom: 10px; }

.filters {
    display: flex;
    gap: 20px;
    margin-bottom: 15px;
}

.dropdown {
    position: relative;
}

.dropdown button {
    padding: 8px 12px;
    border: 1px solid #333;
    background: white;
    cursor: pointer;
}

.dropdown-content {
    display: none;
    position: absolute;
    background: white;
    border: 1px solid #ccc;
    max-height: 260px;
    overflow-y: auto;
    padding: 8px;
    z-index: 10;
    width: 200px;
}

.dropdown:hover .dropdown-content {
    display: block;
}

.dropdown-content label {
    display: block;
    font-size: 13px;
    margin-bottom: 4px;
}

.action-btn {
    font-size: 12px;
    margin-bottom: 6px;
    width: 100%;
    cursor: pointer;
}

canvas {
    background: white;
    padding: 10px;
    border-radius: 6px;
    margin-bottom: 15px;
}

.summary {
    background: white;
    padding: 10px;
    margin-bottom: 15px;
}

.summary table {
    width: 100%;
    border-collapse: collapse;
}

.summary th, .summary td {
    border: 1px solid #ccc;
    padding: 8px;
    text-align: center;
    font-size: 14px;
}

.summary th {
    background: #34495e;
    color: white;
}

.table-wrapper {
    max-height: 400px;
    overflow-y: auto;
    background: white;
}

table.data-table {
    width: 100%;
    border-collapse: collapse;
}

.data-table th, .data-table td {
    border: 1px solid #ccc;
    padding: 6px;
    font-size: 13px;
    text-align: center;
}

.data-table th {
    background: #34495e;
    color: white;
    position: sticky;
    top: 0;
}
</style>
</head>

<body>

<h2>☀️ Solar Plant Performance Dashboard</h2>

<div class="filters">
    <!-- Plant Filter -->
    <div class="dropdown">
        <button>Select Plant</button>
        <div class="dropdown-content" id="plantFilter">
            <button class="action-btn" onclick="selectAll('plant')">Select All</button>
            <button class="action-btn" onclick="deselectAll('plant')">Deselect All</button>
        </div>
    </div>

    <!-- Month Filter -->
    <div class="dropdown">
        <button>Select Month</button>
        <div class="dropdown-content" id="monthFilter">
            <button class="action-btn" onclick="selectAll('month')">Select All</button>
            <button class="action-btn" onclick="deselectAll('month')">Deselect All</button>
        </div>
    </div>
</div>

<!-- SMALL CHART -->
<canvas id="barChart" width="400" height="150"></canvas>

<!-- SUMMARY TABLE -->
<div class="summary">
<table>
<tr>
    <th>Actual Generation (MWh)</th>
    <th>Expected Generation (MWh)</th>
    <th>Difference (%)</th>
</tr>
<tr>
    <td id="sumActual">0</td>
    <td id="sumExpected">0</td>
    <td id="avgDiff">0</td>
</tr>
</table>
</div>

<!-- DATA TABLE -->
<div class="table-wrapper">
<table class="data-table" id="dataTable">
    <thead></thead>
    <tbody></tbody>
</table>
</div>

<script>
// ================= SHEET DETAILS =================
const SHEET_ID = "1Y3cr91xEEQj86B9hXMYdpp6UU1a33-vlrFcWKkLRujg";
const GID = "0";
const MAX_COLUMNS = 19;

// Column index (0-based)
const PLANT_COL = 0;
const MONTH_COL = 1;
const ACTUAL_COL = 3;    // kWh
const EXPECTED_COL = 4;  // kWh
// ================================================

let allData = [];
let selectedPlants = new Set();
let selectedMonths = new Set();
let chart;

const sheetURL =
`https://docs.google.com/spreadsheets/d/${SHEET_ID}/export?format=csv&gid=${GID}`;

fetch(sheetURL)
.then(res => res.text())
.then(csv => {
    const rows = csv.split("\n").map(r =>
        r.split(",").slice(0, MAX_COLUMNS).map(c => c.replace(/"/g, "").trim())
    );

    const headers = rows.shift();
    allData = rows;

    createHeader(headers);
    createFilters();
    updateView();
});

// ---------- HEADER ----------
function createHeader(headers) {
    document.querySelector("#dataTable thead").innerHTML =
        "<tr>" + headers.map(h => `<th>${h}</th>`).join("") + "</tr>";
}

// ---------- FILTERS ----------
function createFilters() {
    const plantSet = new Set();
    const monthSet = new Set();

    allData.forEach(r => {
        plantSet.add(r[PLANT_COL]);
        monthSet.add(r[MONTH_COL]);
    });

    plantSet.forEach(p => addCheckbox("plantFilter", p, selectedPlants));
    monthSet.forEach(m => addCheckbox("monthFilter", m, selectedMonths));
}

function addCheckbox(containerId, value, set) {
    const div = document.getElementById(containerId);
    const label = document.createElement("label");
    const cb = document.createElement("input");

    cb.type = "checkbox";
    cb.checked = true;
    set.add(value);

    cb.onchange = () => {
        cb.checked ? set.add(value) : set.delete(value);
        updateView();
    };

    label.appendChild(cb);
    label.append(" " + value);
    div.appendChild(label);
}

// ---------- SELECT / DESELECT ----------
function selectAll(type) {
    const set = type === "plant" ? selectedPlants : selectedMonths;
    document.querySelectorAll(`#${type}Filter input[type=checkbox]`).forEach(cb => {
        cb.checked = true;
        set.add(cb.nextSibling.textContent.trim());
    });
    updateView();
}

function deselectAll(type) {
    const set = type === "plant" ? selectedPlants : selectedMonths;
    set.clear();
    document.querySelectorAll(`#${type}Filter input[type=checkbox]`).forEach(cb => {
        cb.checked = false;
    });
    updateView();
}

// ---------- UPDATE ----------
function updateView() {
    updateTable();
    updateChart();
    updateSummary();
}

// ---------- TABLE ----------
function updateTable() {
    const tbody = document.querySelector("#dataTable tbody");
    tbody.innerHTML = "";

    allData.forEach(r => {
        if (selectedPlants.has(r[PLANT_COL]) && selectedMonths.has(r[MONTH_COL])) {
            tbody.innerHTML += `<tr>${r.map(c => `<td>${c}</td>`).join("")}</tr>`;
        }
    });
}

// ---------- SUMMARY ----------
function updateSummary() {
    let actualSum = 0;
    let expectedSum = 0;
    let diffTotal = 0;
    let count = 0;

    allData.forEach(r => {
        if (selectedPlants.has(r[PLANT_COL]) && selectedMonths.has(r[MONTH_COL])) {
            const actual = Number(r[ACTUAL_COL]) || 0;
            const expected = Number(r[EXPECTED_COL]) || 0;

            actualSum += actual;
            expectedSum += expected;

            if (expected > 0) {
                diffTotal += ((actual - expected) / expected) * 100;
                count++;
            }
        }
    });

    document.getElementById("sumActual").innerText = (actualSum / 1000).toFixed(2);
    document.getElementById("sumExpected").innerText = (expectedSum / 1000).toFixed(2);
    document.getElementById("avgDiff").innerText =
        count ? (diffTotal / count).toFixed(2) + " %" : "0 %";
}

// ---------- CHART ----------
function updateChart() {
    const monthTotals = {};

    allData.forEach(r => {
        if (selectedPlants.has(r[PLANT_COL]) && selectedMonths.has(r[MONTH_COL])) {
            const m = r[MONTH_COL];
            const gen = (Number(r[ACTUAL_COL]) || 0) / 1000;
            monthTotals[m] = (monthTotals[m] || 0) + gen;
        }
    });

    if (chart) chart.destroy();

    chart = new Chart(document.getElementById("barChart"), {
        type: "bar",
        data: {
            labels: Object.keys(monthTotals),
            datasets: [{
                label: "Actual Generation (MWh)",
                data: Object.values(monthTotals),
                barThickness: 18
            }]
        },
        options: {
            responsive: false,
            scales: {
                x: { ticks: { font: { size: 8 } } },
                y: {
                    beginAtZero: true,
                    ticks: { font: { size: 12 } },
                    title: { display: false }
                }
            }
        }
    });
}
</script>

</body>
</html>
