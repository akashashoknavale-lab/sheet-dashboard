<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Solar Plant Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body {
    font-family: Arial, sans-serif;
    background: #f2f2f2;
    padding: 15px;
}

h2 { margin-bottom: 10px; }

.filters {
    display: flex;
    gap: 20px;
    margin-bottom: 15px;
}

.dropdown {
    position: relative;
}

.dropdown button {
    padding: 6px 10px;
    border: 1px solid #333;
    background: white;
    cursor: pointer;
    font-size: 13px;
}

.dropdown-content {
    display: none;
    position: absolute;
    background: white;
    border: 1px solid #ccc;
    max-height: 260px;
    overflow-y: auto;
    padding: 6px;
    z-index: 10;
    width: 200px;
}

.dropdown:hover .dropdown-content {
    display: block;
}

.dropdown-content label {
    display: block;
    font-size: 12px;
    margin-bottom: 4px;
}

/* üîπ SMALL SIZE ACTION BUTTONS */
.action-btn {
    font-size: 10px;
    padding: 3px;
    margin-bottom: 4px;
    width: 100%;
    cursor: pointer;
    border: 1px solid #aaa;
    background: #eee;
}

canvas {
    background: white;
    padding: 10px;
    border-radius: 6px;
    margin-bottom: 15px;
}

.summary {
    background: white;
    padding: 10px;
    margin-bottom: 15px;
}

.summary table {
    width: 100%;
    border-collapse: collapse;
}

.summary th, .summary td {
    border: 1px solid #ccc;
    padding: 8px;
    text-align: center;
    font-size: 14px;
}

.summary th {
    background: #34495e;
    color: white;
}

.table-wrapper {
    max-height: 400px;
    overflow-y: auto;
    background: white;
}

table.data-table {
    width: 100%;
    border-collapse: collapse;
}

.data-table th, .data-table td {
    border: 1px solid #ccc;
    padding: 6px;
    font-size: 13px;
    text-align: center;
}

.data-table th {
    background: #34495e;
    color: white;
    position: sticky;
    top: 0;
}
</style>
</head>

<body>

<h2>‚òÄÔ∏è Solar Plant Performance Dashboard</h2>

<div class="filters">
    <!-- Plant Filter -->
    <div class="dropdown">
        <button>Select Plant</button>
        <div class="dropdown-content" id="plantFilter">
            <button class="action-btn" onclick="selectAll('plant')">Select All</button>
            <button class="action-btn" onclick="deselectAll('plant')">Deselect All</button>
        </div>
    </div>

    <!-- Month Filter -->
    <div class="dropdown">
        <button>Select Month</button>
        <div class="dropdown-content" id="monthFilter">
            <button class="action-btn" onclick="selectAll('month')">Select All</button>
            <button class="action-btn" onclick="deselectAll('month')">Deselect All</button>
        </div>
    </div>
</div>

<!-- CHART -->
<canvas id="barChart" width="400" height="150"></canvas>

<!-- SUMMARY TABLE -->
<div class="summary">
<table>
<tr>
    <th>Actual Generation (MWh)</th>
    <th>Expected Generation (MWh)</th>
    <th>Difference (%)</th>
</tr>
<tr>
    <td id="sumActual">0</td>
    <td id="sumExpected">0</td>
    <td id="avgDiff">0</td>
</tr>
</table>
</div>

<!-- DATA TABLE -->
<div class="table-wrapper">
<table class="data-table" id="dataTable">
    <thead></thead>
    <tbody></tbody>
</table>
</div>

<script>
const SHEET_ID = "1Y3cr91xEEQj86B9hXMYdpp6UU1a33-vlrFcWKkLRujg";
const GID = "0";
const MAX_COLUMNS = 19;

const PLANT_COL = 0;
const MONTH_COL = 1;
const ACTUAL_COL = 3;
const EXPECTED_COL = 4;

let allData = [];
let selectedPlants = new Set();
let selectedMonths = new Set();
let chart;

const sheetURL =
`https://docs.google.com/spreadsheets/d/${SHEET_ID}/export?format=csv&gid=${GID}`;

fetch(sheetURL)
.then(res => res.text())
.then(csv => {
    const rows = csv.split("\n").map(r =>
        r.split(",").slice(0, MAX_COLUMNS).map(c => c.replace(/"/g, "").trim())
    );

    const headers = rows.shift();
    allData = rows;

    document.querySelector("#dataTable thead").innerHTML =
        "<tr>" + headers.map(h => `<th>${h}</th>`).join("") + "</tr>";

    createFilters();
    updateView();
});

function createFilters() {
    [...new Set(allData.map(r => r[PLANT_COL]))].forEach(p => addCheckbox("plantFilter", p, selectedPlants));
    [...new Set(allData.map(r => r[MONTH_COL]))].forEach(m => addCheckbox("monthFilter", m, selectedMonths));
}

function addCheckbox(containerId, value, set) {
    const div = document.getElementById(containerId);
    const label = document.createElement("label");
    const cb = document.createElement("input");

    cb.type = "checkbox";
    cb.checked = true;
    set.add(value);

    cb.onchange = () => {
        cb.checked ? set.add(value) : set.delete(value);
        updateView();
    };

    label.appendChild(cb);
    label.append(" " + value);
    div.appendChild(label);
}

function selectAll(type) {
    const set = type === "plant" ? selectedPlants : selectedMonths;
    document.querySelectorAll(`#${type}Filter input`).forEach(cb => {
        cb.checked = true;
        set.add(cb.nextSibling.textContent.trim());
    });
    updateView();
}

function deselectAll(type) {
    const set = type === "plant" ? selectedPlants : selectedMonths;
    set.clear();
    document.querySelectorAll(`#${type}Filter input`).forEach(cb => cb.checked = false);
    updateView();
}

function updateView() {
    updateTable();
    updateChart();
    updateSummary();
}

function updateTable() {
    const tbody = document.querySelector("#dataTable tbody");
    tbody.innerHTML = "";

    allData.forEach(r => {
        if (selectedPlants.has(r[PLANT_COL]) && selectedMonths.has(r[MONTH_COL])) {
            tbody.innerHTML += `<tr>${r.map(c => `<td>${c}</td>`).join("")}</tr>`;
        }
    });
}

function updateSummary() {
    let a = 0, e = 0, d = 0, c = 0;

    allData.forEach(r => {
        if (selectedPlants.has(r[PLANT_COL]) && selectedMonths.has(r[MONTH_COL])) {
            const ac = +r[ACTUAL_COL] || 0;
            const ex = +r[EXPECTED_COL] || 0;
            a += ac;
            e += ex;
            if (ex) { d += ((ac - ex) / ex) * 100; c++; }
        }
    });

    sumActual.innerText = (a / 1000).toFixed(2);
    sumExpected.innerText = (e / 1000).toFixed(2);
    avgDiff.innerText = c ? (d / c).toFixed(2) + " %" : "0 %";
}

function updateChart() {
    const actual = {};
    const expected = {};

    allData.forEach(r => {
        if (selectedPlants.has(r[PLANT_COL]) && selectedMonths.has(r[MONTH_COL])) {
            const m = r[MONTH_COL];
            actual[m] = (actual[m] || 0) + (+r[ACTUAL_COL] || 0) / 1000;
            expected[m] = (expected[m] || 0) + (+r[EXPECTED_COL] || 0) / 1000;
        }
    });

    if (chart) chart.destroy();

    chart = new Chart(barChart, {
        type: "bar",
        data: {
            labels: Object.keys(actual),
            datasets: [
                { label: "Actual Generation (MWh)", data: Object.values(actual), barThickness: 14 },
                { label: "Expected Generation (MWh)", data: Object.values(expected), barThickness: 14 }
            ]
        },
        options: {
            responsive: false,
            plugins: {
                title: {
                    display: true,
                    text: "Total Generation ‚Äì Actual vs Expected (MWh)"
                }
            },
            scales: {
                x: { ticks: { font: { size: 8 } } },
                y: { ticks: { font: { size: 12 } }, beginAtZero: true }
            }
        }
    });
}
</script>

</body>
</html>
