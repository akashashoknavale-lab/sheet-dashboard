<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Solar Plant Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
/* ===== YOUR CSS – UNCHANGED ===== */
body { font-family: Arial, sans-serif; background:#f2f2f2; padding:15px; }
h2 { text-align:center; margin-bottom:15px; }
.filters { display:flex; gap:20px; margin-bottom:15px; }
.dropdown { position:relative; }
.dropdown button { padding:3px 6px; font-size:12px; }
.dropdown-content { display:none; position:absolute; background:white; border:1px solid #ccc; max-height:260px; overflow:auto; padding:8px; width:200px; z-index:10; }
.dropdown:hover .dropdown-content { display:block; }
.comparison-container, .comparison-row-2 { display:flex; gap:10px; }
.top-container { display:flex; gap:15px; }
.chart-grid { width:32%; display:grid; grid-template-columns:1fr 1fr; gap:10px; }
.chart-grid canvas { background:white; padding:5px; border-radius:10px; }
.comparison-table { width:120px; border-collapse:collapse; background:white; }
.comparison-table th, .comparison-table td { border:1px solid #ccc; padding:4px; font-size:10px; text-align:center; }
.comparison-table th { background:#34495e; color:white; }
.table-wrapper { max-height:400px; overflow:auto; background:white; }
.data-table { width:100%; border-collapse:collapse; }
.data-table th, .data-table td { border:1px solid #ccc; padding:6px; font-size:10px; text-align:center; }
.data-table th { background:#34495e; color:white; position:sticky; top:0; }
</style>
</head>

<body>

<h2>☀️ Captive Plant Solar Park 1 & 2</h2>

<div class="filters">
  <div class="dropdown">
    <button>Select Plant</button>
    <div class="dropdown-content" id="plantFilter"></div>
  </div>
  <div class="dropdown">
    <button>Select Month</button>
    <div class="dropdown-content" id="monthFilter"></div>
  </div>
</div>

<div class="top-container">

<div>
<div class="comparison-container">
  <table class="comparison-table"><tr><th>Actual</th><th>Expected</th><th>Diff</th></tr>
  <tr><td id="genActual">0</td><td id="genExpected">0</td><td id="genDiff">0%</td></tr></table>

  <table class="comparison-table"><tr><th>Actual</th><th>Expected</th><th>Diff</th></tr>
  <tr><td id="irActual">0</td><td id="irExpected">0</td><td id="irDiff">0%</td></tr></table>

  <table class="comparison-table"><tr><th>Actual</th><th>Expected</th><th>Diff</th></tr>
  <tr><td id="expIRActual">0</td><td id="expIRExpected">0</td><td id="expIRDiff">0%</td></tr></table>
</div>

<div class="comparison-row-2">
  <table class="comparison-table"><tr><th>Actual</th><th>Expected</th></tr>
  <tr><td id="cufActual">0%</td><td id="cufExpected">0%</td></tr></table>

  <table class="comparison-table"><tr><th>Actual</th><th>Expected</th></tr>
  <tr><td id="prActual">0%</td><td id="prExpected">0%</td></tr></table>
</div>
</div>

<div class="chart-grid">
  <canvas id="barChart"></canvas>
  <canvas id="pieGen"></canvas>
  <canvas id="piePR"></canvas>
  <canvas id="pieCUF"></canvas>
</div>

</div>

<div class="table-wrapper">
<table class="data-table" id="dataTable"><thead></thead><tbody></tbody></table>
</div>

<script>
const SHEET_ID="1Y3cr91xEEQj86B9hXMYdpp6UU1a33-vlrFcWKkLRujg";
const GID="0";
const MAX_COL=19;

const PLANT=0, MONTH=1, ACT=3, EXP=4, IR_A=5, IR_E=6, PR_A=8, PR_E=9, CUF_A=10, CUF_E=11;

let data=[], plants=new Set(), months=new Set();
let bar, pGen, pPR, pCUF;

fetch(`https://docs.google.com/spreadsheets/d/${SHEET_ID}/export?format=csv&gid=${GID}`)
.then(r=>r.text()).then(csv=>{
  const rows=csv.split("\n").map(r=>r.split(",").slice(0,MAX_COL).map(c=>c.replace(/"/g,"")));
  const head=rows.shift();
  data=rows;
  dataTable.tHead.innerHTML="<tr>"+head.map(h=>`<th>${h}</th>`).join("")+"</tr>";
  [...new Set(data.map(r=>r[PLANT]))].forEach(v=>addCB("plantFilter",v,plants));
  [...new Set(data.map(r=>r[MONTH]))].forEach(v=>addCB("monthFilter",v,months));
  update();
});

function addCB(id,v,set){
  const l=document.createElement("label");
  const c=document.createElement("input");
  c.type="checkbox"; c.checked=true; set.add(v);
  c.onchange=()=>{c.checked?set.add(v):set.delete(v);update();}
  l.append(c," ",v); document.getElementById(id).append(l);
}

function update(){
  drawTable(); drawCharts();
}

function drawTable(){
  dataTable.tBodies[0].innerHTML="";
  data.forEach(r=>{
    if(plants.has(r[PLANT]) && months.has(r[MONTH])){
      const tr=document.createElement("tr");
      r.forEach(c=>tr.innerHTML+=`<td>${c}</td>`);
      dataTable.tBodies[0].append(tr);
    }
  });
}

function drawCharts(){
  const g={}, pr={}, cuf={};
  data.forEach(r=>{
    if(plants.has(r[PLANT]) && months.has(r[MONTH])){
      g[r[PLANT]]=(g[r[PLANT]]||0)+(+r[ACT]/1000);
      pr[r[PLANT]]=(pr[r[PLANT]]||0)+(+r[PR_A]||0);
      cuf[r[PLANT]]=(cuf[r[PLANT]]||0)+(+r[CUF_A]||0);
    }
  });

  bar?.destroy(); pGen?.destroy(); pPR?.destroy(); pCUF?.destroy();

  bar=new Chart(document.getElementById("barChart"),{type:"bar",data:{labels:Object.keys(g),datasets:[{data:Object.values(g)}]}});
  pGen=new Chart(document.getElementById("pieGen"),{type:"pie",data:{labels:Object.keys(g),datasets:[{data:Object.values(g)}]}});
  pPR=new Chart(document.getElementById("piePR"),{type:"pie",data:{labels:Object.keys(pr),datasets:[{data:Object.values(pr)}]}});
  pCUF=new Chart(document.getElementById("pieCUF"),{type:"pie",data:{labels:Object.keys(cuf),datasets:[{data:Object.values(cuf)}]}});
}
</script>

</body>
</html>
