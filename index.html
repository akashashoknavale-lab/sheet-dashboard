<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Solar Plant Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body {
    font-family: Arial, sans-serif;
    background: #f2f2f2;
    padding: 15px;
}

h2 {
    margin-bottom: 10px;
}

.filters {
    display: flex;
    gap: 20px;
    margin-bottom: 15px;
}

.dropdown {
    position: relative;
}

.dropdown button {
    padding: 8px 12px;
    border: 1px solid #333;
    background: white;
    cursor: pointer;
}

.dropdown-content {
    display: none;
    position: absolute;
    background: white;
    border: 1px solid #ccc;
    max-height: 250px;
    overflow-y: auto;
    padding: 10px;
    z-index: 10;
}

.dropdown:hover .dropdown-content {
    display: block;
}

.dropdown-content label {
    display: block;
    margin-bottom: 5px;
    font-size: 13px;
}

canvas {
    background: white;
    padding: 10px;
    border-radius: 6px;
    margin-bottom: 15px;
}

.table-wrapper {
    max-height: 400px;
    overflow-y: auto;
    background: white;
}

table {
    width: 100%;
    border-collapse: collapse;
}

th, td {
    border: 1px solid #ccc;
    padding: 6px;
    font-size: 13px;
    text-align: center;
}

th {
    background: #34495e;
    color: white;
    position: sticky;
    top: 0;
}
</style>
</head>

<body>

<h2>‚òÄÔ∏è Solar Plant Performance Dashboard</h2>

<div class="filters">
    <div class="dropdown">
        <button>Select Plant</button>
        <div class="dropdown-content" id="plantFilter"></div>
    </div>

    <div class="dropdown">
        <button>Select Month</button>
        <div class="dropdown-content" id="monthFilter"></div>
    </div>
</div>

<!-- üîπ SMALL GRAPH (1/4 SIZE) -->
<canvas id="barChart" width="400" height="150"></canvas>

<div class="table-wrapper">
<table id="dataTable">
    <thead></thead>
    <tbody></tbody>
</table>
</div>

<script>
// ================== SHEET DETAILS ==================
const SHEET_ID = "1Y3cr91xEEQj86B9hXMYdpp6UU1a33-vlrFcWKkLRujg";
const GID = "0";
const MAX_COLUMNS = 19;

// Column index (0-based)
const PLANT_COL = 0;
const MONTH_COL = 1;
const ACTUAL_GEN_COL = 3;

// ===================================================
let allData = [];
let selectedPlants = new Set();
let selectedMonths = new Set();
let chart;

const sheetURL =
`https://docs.google.com/spreadsheets/d/${SHEET_ID}/export?format=csv&gid=${GID}`;

fetch(sheetURL)
.then(res => res.text())
.then(csv => {
    const rows = csv.split("\n").map(r =>
        r.split(",").slice(0, MAX_COLUMNS).map(c =>
            c.replace(/"/g, "").trim()
        )
    );

    const headers = rows.shift();
    allData = rows;

    createHeader(headers);
    createFilters();
    updateView();
});

// ---------- TABLE HEADER ----------
function createHeader(headers) {
    document.querySelector("#dataTable thead").innerHTML =
        "<tr>" + headers.map(h => `<th>${h}</th>`).join("") + "</tr>";
}

// ---------- FILTERS ----------
function createFilters() {
    const plantSet = new Set();
    const monthSet = new Set();

    allData.forEach(r => {
        plantSet.add(r[PLANT_COL]);
        monthSet.add(r[MONTH_COL]);
    });

    plantSet.forEach(p => addCheckbox("plantFilter", p, selectedPlants));
    monthSet.forEach(m => addCheckbox("monthFilter", m, selectedMonths));
}

function addCheckbox(containerId, value, set) {
    const div = document.getElementById(containerId);
    const label = document.createElement("label");
    const cb = document.createElement("input");

    cb.type = "checkbox";
    cb.checked = true;
    set.add(value);

    cb.onchange = () => {
        cb.checked ? set.add(value) : set.delete(value);
        updateView();
    };

    label.appendChild(cb);
    label.append(" " + value);
    div.appendChild(label);
}

// ---------- UPDATE VIEW ----------
function updateView() {
    updateTable();
    updateChart();
}

// ---------- TABLE ----------
function updateTable() {
    const tbody = document.querySelector("#dataTable tbody");
    tbody.innerHTML = "";

    allData.forEach(r => {
        if (selectedPlants.has(r[PLANT_COL]) && selectedMonths.has(r[MONTH_COL])) {
            tbody.innerHTML += `<tr>${r.map(c => `<td>${c}</td>`).join("")}</tr>`;
        }
    });
}

// ---------- CHART (MONTH WISE SUM) ----------
function updateChart() {
    const monthTotals = {};

    allData.forEach(r => {
        const plant = r[PLANT_COL];
        const month = r[MONTH_COL];
        const gen = Number(r[ACTUAL_GEN_COL]) || 0;

        if (selectedPlants.has(plant) && selectedMonths.has(month)) {
            monthTotals[month] = (monthTotals[month] || 0) + gen;
        }
    });

    if (chart) chart.destroy();

    chart = new Chart(document.getElementById("barChart"), {
        type: "bar",
        data: {
            labels: Object.keys(monthTotals),
            datasets: [{
                label: "Total Actual Generation",
                data: Object.values(monthTotals),
                barThickness: 18
            }]
        },
        options: {
            responsive: false,
            scales: {
                x: {
                    title: { display: true, text: "Month" }
                },
                y: {
                    beginAtZero: true,
                    title: { display: true, text: "Generation" }
                }
            }
        }
    });
}
</script>

</body>
</html>
